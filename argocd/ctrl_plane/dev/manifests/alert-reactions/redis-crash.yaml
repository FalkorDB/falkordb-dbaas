---
apiVersion: alertreaction.io/v1alpha1
kind: AlertReaction
metadata:
  name: redis-crash-alert
  namespace: observability
spec:
  alertName: RedisCrashed
  actions:
  - name: call-n8n-redis-crash-webhook
    image: dudizimber/karo-reactions-webhook-sender:v0.2.0
    serviceAccount: alert-reaction-actions-sa
    env:
    - name: WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: url
    - name: TIMEOUT_SECONDS
      value: "30"
    - name: AUTH_HEADER
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: auth-header
    - name: ALERT_JSON
      valueFrom:
        alertRef:
          fieldPath: "."
  - name: create-issue-with-logs
    image: python:3-alpine
    serviceAccount: alert-reaction-actions-sa
    command: ["sh", "-c"]
    args:
      - |
        # Install curl
        apk add --no-cache curl tzdata
        
        # Collect logs and create GitHub issue with attachment
        POD_NAME="${POD_NAME}"
        NAMESPACE="${NAMESPACE}"
        CLUSTER="${CLUSTER}"
        VLOGS_URL="http://victorialogs-server.observability.svc.cluster.local:9428"
        export GH_TOKEN="${GITHUB_TOKEN}"
        
        # Create log file
        LOG_FILE="/tmp/redis-crash-${POD_NAME}-$(date +%Y%m%d-%H%M%S).log"
        
        echo "Redis Crash Diagnostics" > "${LOG_FILE}"
        echo "========================" >> "${LOG_FILE}"
        echo "Pod: ${POD_NAME}" >> "${LOG_FILE}"
        echo "Namespace: ${NAMESPACE}" >> "${LOG_FILE}"
        echo "Cluster: ${CLUSTER}" >> "${LOG_FILE}"
        echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${LOG_FILE}"
        echo "" >> "${LOG_FILE}"
        echo "Logs (5 minutes around alert):" >> "${LOG_FILE}"
        echo "" >> "${LOG_FILE}"
        
        # Collect 5 minutes of logs
        curl -s -G "${VLOGS_URL}/select/logsql/query" \
          --data-urlencode "query=pod:\"${POD_NAME}\" AND namespace:\"${NAMESPACE}\" AND container:\"service\" | fields _time, container, level, _msg | sort by (_time) asc" \
          --data-urlencode "limit=99999" \
          --data-urlencode "time=5m" >> "${LOG_FILE}" || echo "Failed to fetch logs" >> "${LOG_FILE}"
        
        echo "✅ Logs collected: ${LOG_FILE}"
        
        # Get Israeli datetime
        ISRAEL_TIME=$(TZ=Asia/Jerusalem date '+%Y-%m-%d %H:%M:%S %Z')
        
        # Create issue title
        TITLE="[CRITICAL] Redis Crash: ${POD_NAME} in ${NAMESPACE} (${CLUSTER}) - ${ISRAEL_TIME}"
        
        # Upload logs to gist using file to avoid argument list too long
        GIST_FILE="redis-crash-${POD_NAME}-$(date +%Y%m%d-%H%M%S).log"
        GIST_PAYLOAD="/tmp/gist-payload.json"
        
        # Create gist JSON payload in a file
        echo '{' > "${GIST_PAYLOAD}"
        echo '  "files": {' >> "${GIST_PAYLOAD}"
        echo '    "'${GIST_FILE}'": {' >> "${GIST_PAYLOAD}"
        echo '      "content": ' >> "${GIST_PAYLOAD}"
        
        # Use Python to properly escape and format log content as JSON
        python3 -c 'import json, sys; print(json.dumps(sys.stdin.read()))' < "${LOG_FILE}" >> "${GIST_PAYLOAD}"
        
        echo '    }' >> "${GIST_PAYLOAD}"
        echo '  },' >> "${GIST_PAYLOAD}"
        echo '  "public": false' >> "${GIST_PAYLOAD}"
        echo '}' >> "${GIST_PAYLOAD}"
        
        # Test GitHub API connectivity first
        echo "Testing GitHub API connectivity..."
        GITHUB_TEST=$(curl -s -w "\nHTTP_CODE:%{http_code}" -H "Authorization: token ${GITHUB_TOKEN}" "${GITHUB_API}/user" 2>&1)
        echo "GitHub API test result: ${GITHUB_TEST}"
        
        # Create gist with error handling
        echo "Creating gist..."
        GIST_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
          -H "Authorization: token ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          "${GITHUB_API}/gists" \
          -d @"${GIST_PAYLOAD}" 2>&1)
        CURL_EXIT=$?
        
        echo "Curl exit code: ${CURL_EXIT}"
        echo "Gist Response (first 1000 chars): $(echo "${GIST_RESPONSE}" | head -c 1000)"
        
        GIST_URL=$(echo "${GIST_RESPONSE}" | sed -n 's/.*"html_url":[[:space:]]*"\([^"]*\)".*/\1/p' | head -1)
        
        # Create issue body
        if [ -n "${GIST_URL}" ]; then
          ISSUE_BODY="## Redis Crash Detected\n\n**Pod:** ${POD_NAME}\n**Namespace:** ${NAMESPACE}\n**Cluster:** ${CLUSTER}\n**Time (IST):** ${ISRAEL_TIME}\n\n**Crash Logs:** [View logs on GitHub Gist](${GIST_URL})"
        else
          echo "Warning: Failed to create gist, creating issue without logs"
          echo "Full Gist Response: ${GIST_RESPONSE}"
          echo "Payload size: $(wc -c < ${GIST_PAYLOAD}) bytes"
          echo "Payload first 500 chars: $(head -c 500 ${GIST_PAYLOAD})"
          ISSUE_BODY="## Redis Crash Detected\n\n**Pod:** ${POD_NAME}\n**Namespace:** ${NAMESPACE}\n**Cluster:** ${CLUSTER}\n**Time (IST):** ${ISRAEL_TIME}\n\n**Note:** Check VictoriaLogs for logs using: \`pod:\\\"${POD_NAME}\\\" AND namespace:\\\"${NAMESPACE}\\\"\`"
        fi
        
        # Create issue via GitHub API
        ISSUE_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API}/repos/${REPO_OWNER}/${REPO_NAME}/issues" \
          -d "{\"title\":\"${TITLE}\",\"body\":\"${ISSUE_BODY}\"}")
        
        ISSUE_NUMBER=$(echo "${ISSUE_RESPONSE}" | sed -n 's/.*"number":[[:space:]]*\([0-9]*\).*/\1/p')
        NODE_ID=$(echo "${ISSUE_RESPONSE}" | grep -m1 '"node_id"' | sed -n 's/.*"node_id":[[:space:]]*"\([^"]*\)".*/\1/p')
        
        echo "✅ Issue #${ISSUE_NUMBER} created with gist logs"
        
        # Add to project board
        curl -s -X POST \
          -H "Authorization: bearer ${GITHUB_TOKEN}" \
          -H "Content-Type: application/json" \
          "${GITHUB_API}/graphql" \
          -d "{\"query\":\"mutation {addProjectV2ItemById(input: {projectId: \\\"${PROJECT_ID}\\\", contentId: \\\"${NODE_ID}\\\"}) {item {id}}}\"}"
        
        echo "✅ Done"
    env:
    - name: POD_NAME
      valueFrom:
        alertRef:
          fieldPath: "labels.pod"
    - name: NAMESPACE
      valueFrom:
        alertRef:
          fieldPath: "labels.namespace"
    - name: CLUSTER
      valueFrom:
        alertRef:
          fieldPath: "labels.cluster"
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: redis-crash-token
          key: token