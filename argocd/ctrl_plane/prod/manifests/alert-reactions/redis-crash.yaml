---
apiVersion: alertreaction.io/v1alpha1
kind: AlertReaction
metadata:
  name: redis-crash-alert
  namespace: observability
spec:
  alertName: RedisCrashed
  actions:
  - name: call-n8n-redis-crash-webhook
    image: dudizimber/karo-reactions-webhook-sender:v0.2.0
    serviceAccount: alert-reaction-actions-sa
    env:
    - name: WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: url
    - name: TIMEOUT_SECONDS
      value: "30"
    - name: AUTH_HEADER
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: auth-header
    - name: ALERT_JSON
      valueFrom:
        alertRef:
          fieldPath: "."
  - name: create-issue-with-logs
    image: python:3-alpine
    serviceAccount: alert-reaction-actions-sa
    command: ["sh", "-c"]
    args:
      - |
        # Install curl
        apk add --no-cache curl tzdata
        
        # Collect logs and create GitHub issue with attachment
        POD_NAME="${POD_NAME}"
        NAMESPACE="${NAMESPACE}"
        CLUSTER="${CLUSTER}"
        VLOGS_URL="http://victorialogs-server.observability.svc.cluster.local:9428"
        export GH_TOKEN="${GITHUB_TOKEN}"
        
        # Create log file
        LOG_FILE="/tmp/redis-crash-${POD_NAME}-$(date +%Y%m%d-%H%M%S).log"
        
        echo "Redis Crash Diagnostics" > "${LOG_FILE}"
        echo "========================" >> "${LOG_FILE}"
        echo "Pod: ${POD_NAME}" >> "${LOG_FILE}"
        echo "Namespace: ${NAMESPACE}" >> "${LOG_FILE}"
        echo "Cluster: ${CLUSTER}" >> "${LOG_FILE}"
        echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${LOG_FILE}"
        echo "" >> "${LOG_FILE}"
        echo "Logs (5 minutes around alert):" >> "${LOG_FILE}"
        echo "" >> "${LOG_FILE}"
        
        # Collect 5 minutes of logs
        curl -s -G "${VLOGS_URL}/select/logsql/query" \
          --data-urlencode "query=pod:\"${POD_NAME}\" AND namespace:\"${NAMESPACE}\" AND container:\"service\" | fields _time, container, level, _msg | sort by (_time) asc" \
          --data-urlencode "limit=99999" \
          --data-urlencode "time=5m" >> "${LOG_FILE}" || echo "Failed to fetch logs" >> "${LOG_FILE}"
        
        echo "‚úÖ Logs collected: ${LOG_FILE}"
        
        # Get Israeli datetime
        ISRAEL_TIME=$(TZ=Asia/Jerusalem date '+%Y-%m-%d %H:%M:%S %Z')
        
        echo "=========================================="
        echo "Starting duplicate issue detection"
        echo "Pod: ${POD_NAME}"
        echo "Namespace: ${NAMESPACE}"
        echo "Cluster: ${CLUSTER}"
        echo "=========================================="
        
        # Check if an open issue already exists for this pod/namespace/cluster
        SEARCH_QUERY="repo:${REPO_OWNER}/${REPO_NAME} is:open is:issue in:title ${POD_NAME} ${NAMESPACE} ${CLUSTER}"
        echo "Search query: ${SEARCH_QUERY}"
        echo "Calling GitHub API to search for existing issues..."
        
        EXISTING_ISSUES=$(curl -s -G \
          -H "Authorization: token ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API}/search/issues" \
          --data-urlencode "q=${SEARCH_QUERY}")
        
        echo "API Response received. Parsing results..."
        echo "Raw response (first 500 chars): ${EXISTING_ISSUES:0:500}"
        
        ISSUE_COUNT=$(echo "${EXISTING_ISSUES}" | grep -o '"total_count":[[:space:]]*[0-9]*' | sed 's/"total_count":[[:space:]]*//g')
        echo "Total count of matching issues: ${ISSUE_COUNT:-0}"
        
        if [ "${ISSUE_COUNT:-0}" -gt 0 ]; then
          EXISTING_ISSUE_NUMBER=$(echo "${EXISTING_ISSUES}" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
          echo "‚ö†Ô∏è  Open issue #${EXISTING_ISSUE_NUMBER} already exists"
          echo "Checking if this is a new crash or duplicate of same crash..."
          
          # Extract crash signature from current logs (argv[0] and argv[1])
          echo "Extracting crash signature from logs..."
          CURRENT_ARGV0=$(grep -o 'argv\[0\]:[[:space:]]*["'"'"'][^"'"'"']*["'"'"']' "${LOG_FILE}" | head -1 | sed 's/argv\[0\]:[[:space:]]*//g' || echo "")
          CURRENT_ARGV1=$(grep -o 'argv\[1\]:[[:space:]]*["'"'"'][^"'"'"']*["'"'"']' "${LOG_FILE}" | head -1 | sed 's/argv\[1\]:[[:space:]]*//g' || echo "")
          
          echo "Current crash signature: argv[0]=${CURRENT_ARGV0}, argv[1]=${CURRENT_ARGV1}"
          
          if [ -z "${CURRENT_ARGV0}" ] || [ -z "${CURRENT_ARGV1}" ]; then
            echo "‚ö†Ô∏è  Warning: Could not extract argv values from logs"
            echo "Proceeding with upload as crash signature is incomplete"
          else
            # Get existing comments to check for duplicate crash signatures
            echo "Fetching existing comments from issue #${EXISTING_ISSUE_NUMBER}..."
            EXISTING_COMMENTS=$(curl -s -G \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${GITHUB_API}/repos/${REPO_OWNER}/${REPO_NAME}/issues/${EXISTING_ISSUE_NUMBER}/comments")
            
            # Extract gist URLs from comments
            GIST_URLS=$(echo "${EXISTING_COMMENTS}" | grep -o 'https://gist.github.com/[^)]*' || echo "")
            
            IS_DUPLICATE=false
            echo "Checking ${GIST_URLS} for duplicate crash signature..."
            
            # Check each gist for matching argv signatures
            for GIST_URL in ${GIST_URLS}; do
              echo "Checking gist: ${GIST_URL}"
              # Extract gist ID and fetch raw content
              GIST_ID=$(echo "${GIST_URL}" | grep -o '[a-f0-9]\{32\}' | head -1)
              if [ -n "${GIST_ID}" ]; then
                GIST_CONTENT=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "${GITHUB_API}/gists/${GIST_ID}" | grep -o '"content":"[^"]*' | head -1 | cut -d'"' -f4 | sed 's/\\n/\n/g')
                
                EXISTING_ARGV0=$(echo "${GIST_CONTENT}" | grep -o 'argv\[0\]:[[:space:]]*["'"'"'][^"'"'"']*["'"'"']' | head -1 | sed 's/argv\[0\]:[[:space:]]*//g' || echo "")
                EXISTING_ARGV1=$(echo "${GIST_CONTENT}" | grep -o 'argv\[1\]:[[:space:]]*["'"'"'][^"'"'"']*["'"'"']' | head -1 | sed 's/argv\[1\]:[[:space:]]*//g' || echo "")
                
                echo "  Existing crash signature: argv[0]=${EXISTING_ARGV0}, argv[1]=${EXISTING_ARGV1}"
                
                if [ "${CURRENT_ARGV0}" = "${EXISTING_ARGV0}" ] && [ "${CURRENT_ARGV1}" = "${EXISTING_ARGV1}" ]; then
                  echo "  üîÑ Match found! Same crash signature detected"
                  IS_DUPLICATE=true
                  break
                fi
              fi
            done
            
            if [ "${IS_DUPLICATE}" = "true" ]; then
              echo "üîÑ Same crash detected - identical argv signature found in existing comments"
              echo "Skipping duplicate log upload to avoid noise"
              exit 0
            fi
          fi
          
          echo "‚úÖ New crash detected - different crash signature, adding logs as comment to existing issue"
          
          # Collect and upload logs to gist for this new crash
          echo "Creating gist with crash logs..."
          GIST_FILE="redis-crash-${POD_NAME}-$(date +%Y%m%d-%H%M%S).log"
          GIST_PAYLOAD="/tmp/gist-payload.json"
          
          echo '{' > "${GIST_PAYLOAD}"
          echo '  "files": {' >> "${GIST_PAYLOAD}"
          echo '    "'${GIST_FILE}'": {' >> "${GIST_PAYLOAD}"
          echo '      "content": ' >> "${GIST_PAYLOAD}"
          python3 -c 'import json, sys; print(json.dumps(sys.stdin.read()))' < "${LOG_FILE}" >> "${GIST_PAYLOAD}"
          echo '    }' >> "${GIST_PAYLOAD}"
          echo '  },' >> "${GIST_PAYLOAD}"
          echo '  "public": false' >> "${GIST_PAYLOAD}"
          echo '}' >> "${GIST_PAYLOAD}"
          
          echo "Uploading gist to GitHub..."
          GIST_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "${GITHUB_API}/gists" \
            -d @"${GIST_PAYLOAD}")
          
          GIST_URL=$(echo "${GIST_RESPONSE}" | sed -n 's/.*"html_url":[[:space:]]*"\([^"]*\)".*/\1/p' | head -1)
          echo "Gist created: ${GIST_URL}"
          
          # Add comment to existing issue
          COMMENT_BODY="### Another crash detected at ${ISRAEL_TIME}\n\n**Crash Logs:** [View logs on GitHub Gist](${GIST_URL})"
          echo "Adding comment to issue #${EXISTING_ISSUE_NUMBER}..."
          
          COMMENT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${GITHUB_API}/repos/${REPO_OWNER}/${REPO_NAME}/issues/${EXISTING_ISSUE_NUMBER}/comments" \
            -d "{\"body\":\"${COMMENT_BODY}\"}")
          
          COMMENT_ID=$(echo "${COMMENT_RESPONSE}" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
          echo "Comment created with ID: ${COMMENT_ID}"
          echo "‚úÖ Successfully added logs as comment to issue #${EXISTING_ISSUE_NUMBER}"
          echo "Exiting without creating duplicate issue."
          exit 0
        fi
        
        echo "‚úÖ No existing open issue found"
        echo "Proceeding to create new issue..."
        
        # Create issue title
        TITLE="[CRITICAL] Redis Crash: ${POD_NAME} in ${NAMESPACE} (${CLUSTER}) - ${ISRAEL_TIME}"
        echo "Issue title: ${TITLE}"
        
        # Upload logs to gist using file to avoid argument list too long
        echo "Creating gist for new issue..."
        GIST_FILE="redis-crash-${POD_NAME}-$(date +%Y%m%d-%H%M%S).log"
        GIST_PAYLOAD="/tmp/gist-payload.json"
        
        # Create gist JSON payload in a file
        echo '{' > "${GIST_PAYLOAD}"
        echo '  "files": {' >> "${GIST_PAYLOAD}"
        echo '    "'${GIST_FILE}'": {' >> "${GIST_PAYLOAD}"
        echo '      "content": ' >> "${GIST_PAYLOAD}"
        
        # Use Python to properly escape and format log content as JSON
        python3 -c 'import json, sys; print(json.dumps(sys.stdin.read()))' < "${LOG_FILE}" >> "${GIST_PAYLOAD}"
        
        echo '    }' >> "${GIST_PAYLOAD}"
        echo '  },' >> "${GIST_PAYLOAD}"
        echo '  "public": false' >> "${GIST_PAYLOAD}"
        echo '}' >> "${GIST_PAYLOAD}"
        
        # Create gist
        echo "Uploading gist to GitHub..."
        GIST_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          "${GITHUB_API}/gists" \
          -d @"${GIST_PAYLOAD}")
        
        GIST_URL=$(echo "${GIST_RESPONSE}" | sed -n 's/.*"html_url":[[:space:]]*"\([^"]*\)".*/\1/p' | head -1)
        echo "Gist URL: ${GIST_URL}"
        
        # Create issue body
        if [ -n "${GIST_URL}" ]; then
          echo "Creating issue with gist logs..."
          ISSUE_BODY="## Redis Crash Detected\n\n**Pod:** ${POD_NAME}\n**Namespace:** ${NAMESPACE}\n**Cluster:** ${CLUSTER}\n**Time (IST):** ${ISRAEL_TIME}\n\n**Crash Logs:** [View logs on GitHub Gist](${GIST_URL})"
        else
          echo "‚ö†Ô∏è  Warning: Failed to create gist, creating issue without logs"
          ISSUE_BODY="## Redis Crash Detected\n\n**Pod:** ${POD_NAME}\n**Namespace:** ${NAMESPACE}\n**Cluster:** ${CLUSTER}\n**Time (IST):** ${ISRAEL_TIME}\n\n**Note:** Check VictoriaLogs for logs using: \`pod:\\\"${POD_NAME}\\\" AND namespace:\\\"${NAMESPACE}\\\"\`"
        fi
        
        # Create issue via GitHub API
        echo "Creating GitHub issue..."
        ISSUE_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API}/repos/${REPO_OWNER}/${REPO_NAME}/issues" \
          -d "{\"title\":\"${TITLE}\",\"body\":\"${ISSUE_BODY}\"}")
        
        ISSUE_NUMBER=$(echo "${ISSUE_RESPONSE}" | sed -n 's/.*"number":[[:space:]]*\([0-9]*\).*/\1/p')
        NODE_ID=$(echo "${ISSUE_RESPONSE}" | grep -m1 '"node_id"' | sed -n 's/.*"node_id":[[:space:]]*"\([^"]*\)".*/\1/p')
        
        echo "‚úÖ Issue #${ISSUE_NUMBER} created successfully"
        echo "Issue URL: https://github.com/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}"
        echo "Node ID: ${NODE_ID}"
        
        # Add to project board
        echo "Adding issue to project board (ID: ${PROJECT_ID})..."
        PROJECT_RESPONSE=$(curl -s -X POST \
          -H "Authorization: bearer ${GITHUB_TOKEN}" \
          -H "Content-Type: application/json" \
          "${GITHUB_API}/graphql" \
          -d "{\"query\":\"mutation {addProjectV2ItemById(input: {projectId: \\\"${PROJECT_ID}\\\", contentId: \\\"${NODE_ID}\\\"}) {item {id}}}\"}")
        
        echo "Project board response: ${PROJECT_RESPONSE}"
        echo "‚úÖ Issue added to project board"
        echo "‚úÖ Done - new issue workflow completed"
    env:
    - name: POD_NAME
      valueFrom:
        alertRef:
          fieldPath: "labels.pod"
    - name: NAMESPACE
      valueFrom:
        alertRef:
          fieldPath: "labels.namespace"
    - name: CLUSTER
      valueFrom:
        alertRef:
          fieldPath: "labels.cluster"
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: redis-crash-token
          key: token
    - name: GITHUB_API
      value: "https://api.github.com"
    - name: REPO_OWNER
      value: "FalkorDB"
    - name: REPO_NAME
      value: "private"
    - name: PROJECT_ID
      value: "PVT_kwDOCFj3QM4BM1wV"