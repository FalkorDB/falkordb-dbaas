---
apiVersion: alertreaction.io/v1alpha1
kind: AlertReaction
metadata:
  name: redis-crash-alert
  namespace: observability
spec:
  alertName: RedisCrashed
  actions:
  - name: call-n8n-redis-crash-webhook
    image: dudizimber/karo-reactions-webhook-sender:v0.2.0
    serviceAccount: alert-reaction-actions-sa
    env:
    - name: WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: url
    - name: TIMEOUT_SECONDS
      value: "30"
    - name: AUTH_HEADER
      valueFrom:
        secretKeyRef:
          name: redis-crash-alert-env
          key: auth-header
    - name: ALERT_JSON
      valueFrom:
        alertRef:
          fieldPath: "."
  # - name: trigger-crash-workflow
  #   image: alpine:latest
  #   serviceAccount: alert-reaction-actions-sa
  #   command: ["sh", "-c"]
  #   args:
  #     - |
  #       # Install curl and jq
  #       apk add --no-cache curl jq
        
  #       echo "=========================================="
  #       echo "Redis Crash Alert Triggered"
  #       echo "Cluster: ${CLUSTER}"
  #       echo "Pod: ${POD_NAME}"
  #       echo "Container: service"
  #       echo "Namespace: ${NAMESPACE}"
  #       echo "=========================================="
        
  #       # Trigger GitHub Workflow with minimal context
  #       echo "Triggering GitHub workflow..."
        
  #       WORKFLOW_RESPONSE=$(curl -s -X POST \
  #         -H "Authorization: token ${GITHUB_TOKEN}" \
  #         -H "Accept: application/vnd.github.v3+json" \
  #         -H "Content-Type: application/json" \
  #         "${GITHUB_API}/repos/${WORKFLOW_REPO_OWNER}/${WORKFLOW_REPO_NAME}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
  #         -d "$(jq -n \
  #           --arg ref "main" \
  #           --arg pod "${POD_NAME}" \
  #           --arg namespace "${NAMESPACE}" \
  #           --arg cluster "${CLUSTER}" \
  #           --arg container "service" \
  #           --arg vmauth "https://vmauth.observability.internal.falkordb.cloud" \
  #           '{
  #             ref: $ref,
  #             inputs: {
  #               pod: $pod,
  #               namespace: $namespace,
  #               cluster: $cluster,
  #               container: $container,
  #               vmauth_url: $vmauth
  #             }
  #           }')")
        
  #       if echo "${WORKFLOW_RESPONSE}" | grep -q "error"; then
  #         echo "❌ Failed to trigger workflow"
  #         echo "${WORKFLOW_RESPONSE}" | jq '.' || echo "${WORKFLOW_RESPONSE}"
  #         exit 1
  #       fi
        
  #       echo "✅ Workflow triggered successfully"
  #       echo "All processing will be handled by the GitHub workflow"
  #   env:
  #   - name: POD_NAME
  #     valueFrom:
  #       alertRef:
  #         fieldPath: "labels.pod"
  #   - name: NAMESPACE
  #     valueFrom:
  #       alertRef:
  #         fieldPath: "labels.namespace"
  #   - name: CLUSTER
  #     valueFrom:
  #       alertRef:
  #         fieldPath: "labels.cluster"
  #   - name: GITHUB_TOKEN
  #     valueFrom:
  #       secretKeyRef:
  #         name: redis-crash-token
  #         key: token
  #   - name: GITHUB_API
  #     value: "https://api.github.com"
  #   - name: REPO_OWNER
  #     value: "FalkorDB"
  #   - name: REPO_NAME
  #     value: "private"
  #   - name: PROJECT_ID
  #     value: "PVT_kwDOCFj3QM4BM1wV"
  #   - name: WORKFLOW_REPO_OWNER
  #     value: "FalkorDB"
  #   - name: WORKFLOW_REPO_NAME
  #     value: "falkordb-omnistrate"
  #   - name: WORKFLOW_FILE
  #     value: "redis-crash-handler.yml"