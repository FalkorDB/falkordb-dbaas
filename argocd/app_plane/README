# Observability Stack - Application plane

Defines the resources that will be deployed in each application cluster to monitor its contents.

The application plane for the observability stack is composed of the following components:

- VictoriaMetrics: Store metrics
  - Alertmanager
- Grafana Alloy: Scrape metrics from applications, and write them to the control plane
- Pod Monitor: Scrape metrics from pods
- Private Service Connect: Send metrics to the control plane

## Adding clusters to be monitored

### GCP Clusters

Steps:

0. Set the following environment variables:
```bash
# App plane Project ID
export PROJECT=
# GCP Region
export REGION=
# GCP App Plane Cluster Name
export CLUSTER=
# Network name where the App Plane cluster is deployed
export NETWORK=
# Range for the Private Service Connect subnet
export RANGE=
# IP Address for the Private Service Connect LB
export IP_ADDRESS=
# PSC Service Attachment ID (from the control plane)
export SERVICE_ATTACHMENT_ID=
# PagerDuty API Key
export PAGERDUTY_API_KEY=
```

1. Create the node pool for the desired cluster

```bash
gcloud container node-pools create observability \
    --cluster=$CLUSTER \
    --region=$REGION \
    --machine-type=e2-standard-2 \
    --disk-size=50 \
    --enable-autoscaling \
    --max-nodes=10 \
    --project=$PROJECT \
    --node-labels=node_pool=observability
```

2. Set the current context to the desired cluster
```bash
gcloud container clusters get-credentials $CLUSTER --region=$REGION --project=$PROJECT
```

3. Create the PagerDuty secret in the cluster
```bash
kubectl create secret generic pagerduty-service-key \
    --from-literal=api-key=$PAGERDUTY_API_KEY \
    --namespace=observability
```

4. Add the cluster credentials to the observability cluster in the control plane
```bash
argocd cluster add CONTEXT --server SERVER
```

5. Create subnet for PSC
```bash
gcloud compute networks subnets create $CLUSTER-observability-consumer \
    --project=$PROJECT  \
    --range=$RANGE \
    --network=$NETWORK \
    --region=$REGION
```

6. Create egress firewall rule for PSC
```bash
gcloud compute firewall-rules create $CLUSTER-observability-egress \
    --project=$PROJECT \
    --network=$NETWORK \
    --action=allow \
    --priority=1000 \
    --direction=egress \
     --rules=all \
    --destination-ranges=$RANGE
```

7. Create static IP address for PSC
```bash 
gcloud compute addresses create $CLUSTER-observability \
    --project=$PROJECT \
    --region=$REGION \
    --subnet=$CLUSTER-observability-consumer \
    --addresses=$IP_ADDRESS
```

8. Create service attachment for PSC
```bash
gcloud compute forwarding-rules create observability-psc \
    --project=$PROJECT \
    --region=$REGION \
    --network=$NETWORK \
    --address=$CLUSTER-observability \
    --target-service-attachment=$SERVICE_ATTACHMENT_ID
```

9. Create internal DNS zone
```bash
gcloud dns managed-zones create $CLUSTER-observability \
    --project=$PROJECT \
    --description="Internal DNS zone for observability" \
    --dns-name=observability.gcp.falkordb.internal. \
    --visibility=private \
    --networks=$NETWORK
```

10. Create record for PSC
```bash
gcloud dns record-sets create victoriametrics.observability.gcp.falkordb.internal. \
    --project=$PROJECT \
    --rrdatas=$IP_ADDRESS \
    --type=A \
    --zone=$CLUSTER-observability
```