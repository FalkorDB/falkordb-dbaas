steps:
  - id: Deploy to Cloud Run
    name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - 'europe-west1-docker.pkg.dev/${_PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}'
      - '--platform'
      - 'managed'
      - '--region'
      - 'europe-west1'
      - '--service-account'
      - 'db-exporter-sa@${_PROJECT_ID}.iam.gserviceaccount.com'
      - '--set-env-vars'
      - 'NODE_ENV=${_NODE_ENV},SERVICE_NAME=${_SERVICE_NAME},EXPORT_BUCKET_NAME=${_EXPORT_BUCKET_NAME},OMNISTRATE_SERVICE_ID=${_OMNISTRATE_SERVICE_ID},OMNISTRATE_ENVIRONMENT_ID=${_OMNISTRATE_ENVIRONMENT_ID},TASKS_REPOSITORY_MONGODB_DB=${_TASKS_REPOSITORY_MONGODB_DB},TASKS_REPOSITORY_MONGODB_COLLECTION=${_TASKS_REPOSITORY_MONGODB_COLLECTION},CTRL_PLANE_PROJECT_ID=${_CTRL_PLANE_PROJECT_ID},CTRL_PLANE_CLUSTER_ID=${_CTRL_PLANE_CLUSTER_ID},CTRL_PLANE_REGION=${_CTRL_PLANE_REGION},NAMESPACE=${_NAMESPACE},APPLICATION_PLANE_PROJECT_ID=${_APPLICATION_PLANE_PROJECT_ID}'
      - '--set-secrets'
      - 'MONGODB_URI=projects/${_PROJECT_ID}/secrets/MONGODB_URI/versions/latest,GOOGLE_RECAPTCHA_SECRET_KEY=projects/${_PROJECT_ID}/secrets/RECAPTCHA_SECRET_KEY/versions/latest,OMNISTRATE_EMAIL=projects/${_PROJECT_ID}/secrets/OMNISTRATE_EMAIL/versions/latest,OMNISTRATE_PASSWORD=projects/${_PROJECT_ID}/secrets/OMNISTRATE_PASSWORD/versions/latest,REDIS_URL=projects/${_PROJECT_ID}/secrets/REDIS_QUEUE_URL/versions/latest'

tags:
  - backend
  - service-db-importer
  - env-${_NODE_ENV}

substitutions:
  _PROJECT_ID: 'ctrl-plane-prod-b1b92df2'
  _PROJECT_NUMBER: '987165368882'
  _REPOSITORY: 'backend'
  _IMAGE_NAME: 'db-importer'
  _SERVICE_NAME: 'db-importer'
  _NODE_ENV: 'production'
  _APPLICATION_PLANE_PROJECT_ID: 'app-plane-prod-b1b92df2'
  _EXPORT_BUCKET_NAME: 'falkordb-prod-rdb-exports-b1b92df2'
  _OMNISTRATE_SERVICE_ID: 's-KgFDwg5vBS'
  _OMNISTRATE_ENVIRONMENT_ID: 'se-1iyXYFtYfA'
  _TASKS_REPOSITORY_MONGODB_DB: 'db-exporter'
  _TASKS_REPOSITORY_MONGODB_COLLECTION: 'tasks'
  _CTRL_PLANE_PROJECT_ID: 'ctrl-plane-prod-b1b92df2'
  _CTRL_PLANE_CLUSTER_ID: 'observability-stack-uvm2'
  _CTRL_PLANE_REGION: 'us-central1'
  _NAMESPACE: 'db-import-export'

