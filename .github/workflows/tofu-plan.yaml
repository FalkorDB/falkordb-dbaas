name: Tofu Plan

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - dev

env:
  TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
  TF_CTRL_PLANE_DEV_PROJECT_ID: ${{ secrets.TF_CTRL_PLANE_PROJECT_ID }}
  TF_CTRL_PLANE_DEV_REGION: ${{ secrets.TF_CTRL_PLANE_REGION }}

jobs:
  load-matrix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read plan-jobs.json
        id: set-matrix
        run: |
          echo matrix="$(jq -r tojson .github/workflows/plan-jobs.json)" >> $GITHUB_OUTPUT
      - name: print matrix
        env:
          TF_CTRL_PLANE_DEV_PROJECT_ID: 'a'
          TF_CTRL_PLANE_DEV_REGION: 'a'
          TF_CTRL_PLANE_IP_RANGE_SUBNET: 'a'
          TF_CTRL_PLANE_IP_RANGE_PODS: 'a'
          TF_CTRL_PLANE_IP_RANGE_SERVICES: a
        run: |
          echo "${{ toJson(steps.set-matrix.outputs.matrix) }}"
    
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix || '["a"]' }}

  plan:
    needs: load-matrix
    name: Plan Tofu Stack ${{ matrix }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        stack: ${{ fromJson(needs.load-matrix.outputs.matrix) }}
    steps:
      - name: print matrix values
        run: |
          echo "${{ toJson(matrix) }}"
          echo "${{ toJson(fromJson(needs.load-matrix.outputs.matrix)) }}"
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Setup environment variables
        run: |
          for key in $(jq -r 'keys[]' <<< '${{ toJson(matrix.stack.variables) }}'); do
            value=$(jq -r --arg key "$key" '.[$key]' <<< '${{ toJson(matrix.stack.variables) }}')
            echo "$key=$value" >> $GITHUB_ENV
          done

      - name: Setup Tofu workspace
        run: |
          cd ${{ matrix.stack.path }}
          tofu init ${{ matrix.stack.init_param }}

      - name: Plan Tofu
        run: |
          cd ${{ matrix.stack.path }}
          tofu plan -out=tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tofu-plan-${{ matrix.stack.name }}
          path: ${{ matrix.stack.path }}/tfplan
